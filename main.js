(()=>{"use strict";class t{constructor(t){this.conteiner=t,this.field=null}init(){this.field=this.conteiner.querySelector(".worklog-logs")}drawLog(e){const s=t.addTagHTML(this.field,"log"),a=t.addTagHTML(s,"log-header"),n=t.addTagHTML(s,"log-server"),i=t.addTagHTML(s,"log-info");e.data?(n.textContent=`Server: ${e.data.id}`,"Received"===e.status?(i.textContent=`INFO: Received "${e.data.command}"`,a.textContent=t.getNewFormatDate(e.data.time)):(i.textContent=`INFO: ${e.status}`,a.textContent=t.getNewFormatDate(e.data.time))):(n.textContent=`Server: ${e.id}`,i.textContent=`INFO: ${e.state}`,a.textContent=t.getNewFormatDate(e.time)),this.field.scrollTop=this.field.scrollHeight}static getNewFormatDate(e){const s=new Date(e),a=String(s.getFullYear()),n=t._addZero(s.getMonth()),i=t._addZero(s.getDate());return`${t._addZero(s.getHours())}:${t._addZero(s.getMinutes())}:${t._addZero(s.getSeconds())} ${i}.${n}.${a}`}static _addZero(t){let e=t;return e<10&&(e=`0${e}`),e}static addTagHTML(t,e=null,s="div"){const a=document.createElement(s);return a.classList.add(e),t.append(a),a}}class e{constructor(t){this.conteiner=t,this.field=null,this.createListeners=[],this.deleteListeners=[],this.changeListeners=[]}init(){this.field=this.conteiner.querySelector(".instances-content");this.conteiner.querySelector(".instances-link").addEventListener("click",(t=>this.onClickCreate(t))),this.field.addEventListener("click",(t=>this.onClickForm(t)))}addInstance(t){const s=e.addTagHTML(this.field,"instance");s.setAttribute("id",t.id);e.addTagHTML(s,"instance-title").textContent=t.id;const a=e.addTagHTML(s,"instance-status");e.addTagHTML(a,"status-header","span").textContent="Status:";e.addTagHTML(a,"status-img").classList.add(t.state.toLowerCase());e.addTagHTML(a,"status-state","span").textContent=t.state;const n=e.addTagHTML(s,"instance-actions");e.addTagHTML(n,"actions-header","span").textContent="Actions:";const i=e.addTagHTML(n,"action-run");"Stopped"===t.state?i.classList.add("play"):i.classList.add("pause"),e.addTagHTML(n,"action-delete"),this.field.scrollTop=this.field.scrollHeight}static deleteInstace(t){document.getElementById(t).remove()}static changeInstace(t,e){const s=document.getElementById(e),a=s.querySelector(".action-run"),n=s.querySelector(".status-img"),i=s.querySelector(".status-state");"Stopped"===t?(a.classList.remove("pause"),a.classList.add("play"),n.classList.remove("running"),n.classList.add("stopped"),i.textContent="Stopped"):(a.classList.remove("play"),a.classList.add("pause"),n.classList.remove("stopped"),n.classList.add("running"),i.textContent="Running")}static addTagHTML(t,e=null,s="div"){const a=document.createElement(s);return a.classList.add(e),t.append(a),a}onClickCreate(t){t.preventDefault(),this.createListeners.forEach((e=>e.call(null,t)))}addClickCreate(t){this.createListeners.push(t)}onClickForm(t){t.preventDefault();const{target:e}=t,s=e.closest(".instance");e.className.includes("action-run")?this.changeListeners.forEach((t=>t.call(null,s))):e.className.includes("action-delete")&&this.deleteListeners.forEach((t=>t.call(null,s)))}addClickChange(t){this.changeListeners.push(t)}addClickDelete(t){this.deleteListeners.push(t)}}const s=document.querySelector(".conteiner-instances"),a=document.querySelector(".conteiner-worklog"),n=new e(s),i=new t(a),d=new class{constructor(t,e,s){this.editorInstance=t,this.editorWorklog=e,this.urlServer=s,this.ws=new WebSocket("wss://javascript-21-websockets-backend-task2.onrender.com")}init(){this.editorInstance.init(),this.editorWorklog.init(),this.editorInstance.addClickCreate(this.onClickCreate.bind(this)),this.editorInstance.addClickDelete(this.onClickDelete.bind(this)),this.editorInstance.addClickChange(this.onClickChange.bind(this)),this.getInstances(),this.ws.addEventListener("message",(t=>{const e=JSON.parse(t.data);this.editorWorklog.drawLog(e),"Created"===e.status&&this.editorInstance.addInstance(e.data),"Removed"===e.status&&this.editorInstance.constructor.deleteInstace(e.data.id),"Stopped"!==e.status&&"Started"!==e.status||this.editorInstance.constructor.changeInstace(e.status,e.data.id)}))}onClickChange(t){let e=null;e=t.querySelector(".action-run").className.includes("play")?"Start command":"Pause command";const s=t.getAttribute("id");this.ws.send(JSON.stringify({command:e,id:s}))}onClickDelete(t){const e=t.getAttribute("id");this.ws.send(JSON.stringify({command:"Delete command",id:e}))}onClickCreate(){this.ws.send(JSON.stringify({command:"Create command"}))}async getInstances(){const t=`${this.urlServer}/instances/`,e=await fetch(t,{method:"GET"}),s=await e.json();for(const t of s)this.editorInstance.addInstance(t),this.editorWorklog.drawLog(t)}getNewFormatDate(t){const e=new Date(t),s=String(e.getFullYear()).slice(2),a=this._addZero(e.getMonth());return`${this._addZero(e.getDate())}.${a}.${s} ${this._addZero(e.getHours())}:${this._addZero(e.getMinutes())}`}}(n,i,"https://javascript-21-websockets-backend-task2.onrender.com");d.init()})();